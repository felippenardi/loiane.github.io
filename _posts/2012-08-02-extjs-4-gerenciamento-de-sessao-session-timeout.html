---
layout: post
title: 'ExtJS 4: Gerenciamento de Sessão: Session Timeout'
date: 2012-08-02 05:00:38.000000000 -03:00
type: post
published: true
status: publish
categories:
- Ext JS 4
tags:
- ExtJS 4
- Gerenciamento de Sessão
- Session Timeout
language: pt-br
tag: pt-br
---
<p>Ei pessoal,</p>
<p>Uma pergunta que recebo bastante por email e nas palestras sobre ExtJS que ministro é: Como fazer gerenciamento de sessão usando ExtJS 4? Bem, nesse post vamos tratar justamente sobre esse assunto através de um exemplo prático!</p>
<p>O exemplo desse post irá mostrar uma mensagem para o usuário perguntando se deseja continuar com a sessão aberta, e caso positivo, a app vai cutucar o servidor para manter a sessão ativa; caso negativo, a app automaticamente faz logout. Essa janela vai ficar 1 minuto aberta; caso o usuário não tome nenhuma decisão, também faz logout. A sessão se torna inativa caso o usuário não tome nenhuma ação em uma quantidade de tempo (exemplo: 15 minutos), isso inclui digitar alguma coisa no teclado ou mexer o mouse:</p>
<p><a href="http://www.loiane.com/wp-content/uploads/2012/07/extjs4-sessiontimeout-loiane.png"><img class="aligncenter size-full wp-image-4934" title="extjs4-sessiontimeout-loiane" alt="" src="{{ site.baseurl }}/images/assets/extjs4-sessiontimeout-loiane.png" width="544" height="525" /></a></p>
<p>A classe que faz toda essa mágica está aqui:</p>
<pre>[code lang="js" firstline="1" toolbar="true" collapse="false" wraplines="false"]&lt;br /&gt;/**&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt; * Session Monitor task, alerts the user that their session will expire in 60 seconds and provides&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt; * the options to continue working or logout.  If the count-down timer expires,  the user is automatically&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt; * logged out.&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt; */&lt;br /&gt;Ext.define('MyApp.widgets.SessionMonitor', {&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;  singleton: true,&lt;br /&gt;&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;  interval: 1000 * 10,  // run every 10 seconds.&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;  lastActive: null,&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;  maxInactive: 1000 * 60 * 15,  // 15 minutes of inactivity allowed; set it to 1 for testing.&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;  remaining: 0,&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;  ui: Ext.getBody(),&lt;br /&gt;&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;  /**&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;   * Dialog to display expiration message and count-down timer.&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;   */&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;  window: Ext.create('Ext.window.Window', {&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;    bodyPadding: 5,&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;    closable: false,&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;    closeAction: 'hide',&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;    modal: true,&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;    resizable: false,&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;    title: 'Session Timeout Warning',&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;    width: 325,&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;    items: [{&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;      xtype: 'container',&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;      frame: true,&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;      html: &quot;Your session will automatically expires after 15 minutes of  inactivity. If your session expires, any unsaved data will be lost and  you will be automatically logged out. &amp;lt;/br&amp;gt;&amp;lt;/br&amp;gt;If you want  to continue working, click the 'Continue Working'  button.&amp;lt;/br&amp;gt;&amp;lt;/br&amp;gt;&quot;&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;    },{&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;      xtype: 'label',&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;      text: ''&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;    }],&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;    buttons: [{&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;      text: 'Continue Working',&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;      handler: function() {&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;        Ext.TaskManager.stop(MyApp.widgets.SessionMonitor.countDownTask);&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;        MyApp.widgets.SessionMonitor.window.hide();&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;        MyApp.widgets.SessionMonitor.start();&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;        // 'poke' the server-side to update your session.&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;        Ext.Ajax.request({&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;          url: 'user/poke.action'&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;        });&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;      }&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;    },{&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;      text: 'Logout',&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;      action: 'logout',&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;      handler: function() {&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;        Ext.TaskManager.stop(MyApp.widgets.SessionMonitor.countDownTask);&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;        MyApp.widgets.SessionMonitor.window.hide();&lt;br /&gt;&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;        // find and invoke your app's &quot;Logout&quot; button.&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;        Ext.ComponentQuery.query('button[action=&quot;buttonLogout&quot;]')[0].fireEvent('click');&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;      }&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;    }]&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;  }),&lt;br /&gt;&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;  /**&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;   * Sets up a timer task to monitor for mousemove/keydown events and&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;   * a count-down timer task to be used by the 60 second count-down dialog.&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;   */&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;  constructor: function(config) {&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;    var me = this;&lt;br /&gt;&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;    // session monitor task&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;    this.sessionTask = {&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;      run: me.monitorUI,&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;      interval: me.interval,&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;      scope: me&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;    };&lt;br /&gt;&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;    // session timeout task, displays a 60 second countdown&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;    // message alerting user that their session is about to expire.&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;    this.countDownTask = {&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;      run: me.countDown,&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;      interval: 1000,&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;      scope: me&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;    };&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;  },&lt;br /&gt;&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;  /**&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;   * Simple method to register with the mousemove and keydown events.&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;   */&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;  captureActivity : function(eventObj, el, eventOptions) {&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;    this.lastActive = new Date();&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;  },&lt;br /&gt;&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;  /**&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;   *  Monitors the UI to determine if you've exceeded the inactivity threshold.&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;   */&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;  monitorUI : function() {&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;    var now = new Date();&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;    var inactive = (now - this.lastActive);&lt;br /&gt;&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;    if (inactive &amp;gt;= this.maxInactive) {&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;      this.stop();&lt;br /&gt;&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;      this.window.show();&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;      this.remaining = 60;  // seconds remaining.&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;      Ext.TaskManager.start(this.countDownTask);&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;    }&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;  },&lt;br /&gt;&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;  /**&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;   * Starts the session timer task and registers mouse/keyboard activity event monitors.&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;   */&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;  start : function() {&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;    this.lastActive = new Date();&lt;br /&gt;&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;    this.ui = Ext.getBody();&lt;br /&gt;&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;    this.ui.on('mousemove', this.captureActivity, this);&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;    this.ui.on('keydown', this.captureActivity, this);&lt;br /&gt;&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;    Ext.TaskManager.start(this.sessionTask);&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;  },&lt;br /&gt;&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;  /**&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;   * Stops the session timer task and unregisters the mouse/keyboard activity event monitors.&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;   */&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;  stop: function() {&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;    Ext.TaskManager.stop(this.sessionTask);&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;    this.ui.un('mousemove', this.captureActivity, this);  //  always wipe-up after yourself...&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;    this.ui.un('keydown', this.captureActivity, this);&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;  },&lt;br /&gt;&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;  /**&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;   * Countdown function updates the message label in the user dialog which displays&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;   * the seconds remaining prior to session expiration.  If the counter expires, you're logged out.&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;   */&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;  countDown: function() {&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;    this.window.down('label').update('Your session will expire in ' +  this.remaining + ' second' + ((this.remaining == 1) ? '.' : 's.') );&lt;br /&gt;&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;    --this.remaining;&lt;br /&gt;&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;    if (this.remaining &amp;lt; 0) {&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;      this.window.down('button[action=&quot;logout&quot;]').handler();&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;    }&lt;br /&gt;&lt;%%KEEPWHITESPACE%%&gt;  }&lt;br /&gt;&lt;br /&gt;});&lt;br /&gt;[/code]</pre>
<p>Vamos ver alguns detalhes importantes:</p>
<ul>
<li><em>linha 11</em>: <em><strong>maxInactive</strong></em> - tempo de inatividade do usuário para inativar a sessão. Nesse caso, o valor padrão são de 15 minutos, mas você pode mudar esse valor para a quantidade de tempo que você deseja (em minutos).</li>
<li><em>linha 29</em>: <em><strong>html</strong></em> - mensagem que será mostrada para o usuário na janela. Está em inglês, mas você pode traduzir para português se desejar.</li>
<li><em>linha 42</em>: <em><strong>url</strong></em> - aqui você vai colocar a url para "<em>cutucar</em>" o servidor para manter a sessão ativa no server também.</li>
<li><em>linha 53</em>: aqui colocamos o selector a ser chamado para disparar o evento de logout automaticamente. Nesse exemplo, repare que tem um botão de logout, e essa linha chama exatamente a função que faz logut (nesse exemplo é apenas um alert, mas isso você deve tratar como deseja na sua aplicação). Só um detalhe: não chame a <strong><em>action</em></strong> do seu botão de logut de <strong><em>logout</em></strong>, pois este já está sendo usado por essa classe.</li>
</ul>
<p>Bem pessoal, é isso!</p>
<p>Se quiser usar essa classe na sua aplicação, basta chamar MyApp.widgets.SessionMonitor.start(). Se estiver usando a arquitetura MVC, coloque isso dentro da função <strong><em>launch</em></strong> da app. No final desse post tem um exemplo de uma app usando essa classe.</p>
<p>Código Fonte Completo: <a href="https://github.com/loiane/extjs4-session-timeout" target="_blank" rel="noopener">https://github.com/loiane/extjs4-session-timeout</a></p>
<blockquote><p><em><strong>Disclaimer</strong></em>: eu não sou autora desse código, portando, qualquer problema reclame nessa thread do fórum da Sencha: <a href="http://www.sencha.com/forum/showthread.php?195957-Session-Timeout-Alert-using-PHP-amp-Extjs4" target="_blank" rel="noopener">http://www.sencha.com/forum/showthread.php?195957-Session-Timeout-Alert-using-PHP-amp-Extjs4</a></p>
</blockquote>
<p>Até a próxima! :)</p>
